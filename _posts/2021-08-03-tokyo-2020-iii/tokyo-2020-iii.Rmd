---
title: "Tokyo 2020 Betting III: From Matches to Medals... and Bookies"
description: |
  In this post I will use posterior draws from the Bradley-Terry model to derive the posterior distribution for the Gold medal winners of the track cycling Individual sprint. I'll then derive an optimal betting strategy using a spread-bet Kelly Criterion.  
date: 08-03-2021
output:
  distill::distill_article:
    toc: true
    toc_depth: 2
  self_contained: false
categories:
  - Bayesian
  - Optimisation
  - Cycling
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, code_folding = TRUE)
options(kableExtra.html.bsTable = T)

library(tidyverse)
library(lubridate)
library(infreqthemes)
library(xaringanExtra)
library(knitr)
library(kableExtra)
library(fst)
library(formattable)

xaringanExtra::use_panelset()

remote_project_path <- '~/Documents/R Projects/track-cycling/'
remote_targets_path <- paste0(remote_project_path, '_targets/objects/')

read_remote_target <- function(name, path = remote_targets_path){
  
  file_path <- paste0(path,name)
  
  tar <- try(read_rds(file_path),silent=TRUE)
  
  if(class(tar) != 'try-error'){return(tar)}
  
  tar <- try(read_fst(file_path),silent=TRUE)
  
  if(class(tar) != 'try-error'){return(tar)}
  else{stop("Failed to read remote target")}
}

```

<details>
<summary>*This is the third post in a series: Click for links.*</summary>

[*Tokyo 2020 Betting I: Predictive Models for Pairwise Matches*](https://www.infreq.com/posts/2021-07-23-tokyo-2020-i/) 

[*Tokyo 2020 Betting II: Model Refinement and Feature Engineering*](https://www.infreq.com/posts/2021-07-28-tokyo-2020-ii/)

[*Tokyo 2020 Betting III: From Matches to Medals... and Bookies*](https://www.infreq.com/posts/2021-08-03-tokyo-2020-stakes-holding/) **(This Post)**
</details>

So far in this series I've focused on predicting the outcome of matches between single matches between two athletes, and derived a bespoke Bradley-Terry model for this purpose. To construct a betting strategy I will need to turn the probability that a given rider wins a single match, into the probability that they will win the whole tournament - and hence the gold medal.

In the first section of this post I'll introduce the tournament format for the Tokyo 2020 Individual Sprint, and use the custom Bradley-Terry model developed in the previous posts to derive a distribution for the gold medal winners.

In the second part I will summarise the Kelly Criterion for multiple bets, and explain how we can use this to derive a betting strategy that takes into account both the uncertainty implied by our model (even the strongest athlete won't always win) and the Bayesian (posterior) uncertainty in the athletes' strengths.

At the very end I will log the actual bets that I placed on Tokyo 2020; a review of the successes and failures of the bets, and the analysis will be the focus of a final summary post to follow.

### Assumptions
This post makes some assumptions about you!

I'll assume you've read the previous posts in the series, though this post should work as a standalone.

I'll also assume you have some knowledge of basic betting terminology (fractional odds, stakes). To derive my betting strategy I will use some discrete probability, and formalise a non-linear optimisation model.

If you're interested in reading the underlying code, this is in R..

<aside>The full model code, from model fitting to betting stakes is [here](https://github.com/odaniel1/track-cycling/tree/targets).</aside>

## Tournament Forecasting

The Individual Sprint has a complex tournament structure, which will see the winning athlete compete between 10 and 16 sprints before they can claim the medal!

There are four main parts to the tournament structure, which in Tokyo 2020 will see 30 athletes compete:

::::: {.panelset}

::: {.panel}
[Overview]{.panel-name}


* A *qualifying* round that sees all athletes competing individually to set the fastest time, with the six slowest athletes eliminated.

* *1/2N Finals* that see the $2N$ remaining athletes compete in pairs. The winner of a single sprint automatically qualifies for the next 1/2M Final.

* *Repechage* races that see the N losers from the 1/2N round competing to take the additional places in the next 1/2M Final.

* *Quarter-, Semi-, and Finals* raced between pairs of riders. The match is contested in a best of three sprints format.

For instance, in Tokyo the twelve winners of the 1/24 Final automatically qualify for the next main round.

The twelve losing riders will be split into four repechage matches of three athletes, the four winners will join the twelve previous qualifiers and compete in the 1/16 final.
:::

:::{.panel}
[Tokyo 2020 Summary]{.panel-name}

| Round | Athletes Competing | Matches x Athletes per Match | Sprints per Match | Athletes Qualifying |
|---|:-:|:-:|:-:|:-:|
| Qualifying | 30 | 30 x 1 | 1 |24  |
| 1/24 Finals | 24 | 12 x 2 | 1 | 12 |
| *Repechage 1* | 12 | 4 x 3 | 1 | 4 |
| 1/16 Finals | 16 | 8 x 2 | 1 | 8 |
| *Repechage 2* | 8 | 4 x 2 | 1 | 4 |
| 1/12 Finals | 12 | 6 x 2 | 1 | 6 |
| *Repechage 3* | 6 | 2 x 3 | 1 | 2 |
| Quarterfinals | 8 | 4 x 2 | Best of 3 | 4 |
| Semifinals | 4 | 2 x 2 |  Best of 3 | 2 |
| Finals | 2 | 2 x 1 |  Best of 3 | 1 |
:::

:::{.panel}
[Tokyo 2020 Detail]{.panel-name}
This is the detailed table published by the UCI in their [Track Regulations](https://www.uci.org/docs/default-source/rules-and-regulations/3-pis-20210610-e.pdf) which specifies the details of which riders will face each other.

The initial rider codes N1-N24 are in order of the time posted in the qualifying round: N1 is the fastest qualifier, N24 the slowest.

```{r}
read_remote_target("fcst_rounds_Men") %>%
  select(-round_no,-competitors) %>%
  kable("pipe") %>%
  kable_styling(full_width = FALSE, bootstrap_options = list(condensed = TRUE), font_size = 7)
```

:::
:::::

Given the detailed tournament table above, and a set of athlete strengths $\alpha_r$, we can simulate entire tournaments by sampling matches 



## Deriving the Betting Strategy


With the qualifying rounds of the Men's individual sprint starting tomorrow, its time to put some money behind my analysis.

The analytical workflow to go from model optimisation through to betting stakes are complete, but drafting a full blog post detailing how I've gone from predicting individual matches to entire tournaments, and then the defining betting stakes was beyond me in the time available.

<aside>All that detail in code form is available [here](https://github.com/odaniel1/track-cycling).</aside> 

In due course this blog post will morph to contain the details of the analysis - but for now this will be a holding space to report the odds I was being offered, and the and the stakes I put against these.



## Betting Log

In total I allowed myself a budget of £20 - not exactly betting big, but also a non-negligible amount which will give me the flexibility to make a number of bets.

For each of the men's and women's events I bet three times: 

* Prior to qualifying - using historic data only.

* Immediately after qualifying - including the qualifying times in the model.

* Prior to the semi-finals - re-training the model to include the now observed preliminary rounds.

At each stage I used the Kelly Criterion to set my stakes; to avoid blowing my budget early I capped my expenditure in earlier rounds at 1/6 of the total budget (£3.40).

::::: {.panelset}

::: {.panel}
[Men]{.panel-name}

### Pre-Qualifying

```{r, echo = FALSE}
stakes <- read_csv("../../../track-cycling/data/bets/2020-08-04-Men-PreQualifying.csv")
```

```{r stakes-table, echo = FALSE}
stakes %>%
  filter(capped_kelly_stakes > 0) %>%
  select(
    `Athlete` = rider, `Odds` = fractional_odds, `Stake` = capped_kelly_stakes,
    `Modelled Gold Prob.` = gold_prob, `Expected Return`= expected_return
  ) %>%
  kable("pipe", digits = 2)
```

<details>
<summary>All Other Odds</summary>
```{r no-stakes-table, echo = FALSE}
stakes %>%
  filter(capped_kelly_stakes == 0) %>%
 select(
    `Athlete` = rider, `Odds` = fractional_odds, `Stake` = capped_kelly_stakes,
    `Modelled Gold Prob.` = gold_prob, `Expected Return`= expected_return
  ) %>%
  kable("pipe", digits = 2)
```
</details>

<details>
<summary>Notes</summary>
The idea of betting at this point is that hopefully the bookies odds are naive, as they won't have adjusted for qualifying times. We saw in the [previous post](https://www.infreq.com/posts/2021-07-28-tokyo-2020-ii/) qualifying data is highly predictive of match results.

Since qualifying times are not available I've fitted the model assuming all riders have the same qualifying time, and seeded them for matches in order of strength.
</details>

### Post Qualifying


```{r,echo = FALSE}
stakes <- read_csv("../../../track-cycling/data/bets/2020-08-04-Men-PostQualifying.csv")
```

```{r, stakes-table, echo = FALSE}
```

<details>
<summary>All Other Odds</summary>
```{r, no-stakes-table, echo = FALSE}
```
</details>

<details>
<summary>Notes</summary>
These bets were placed ahead of the 1/32 finals; at this point 24 athlete's remained in the competition.

Unfortunately at this point I'm already down £2.40 - Matthew Glaetzer was substituted out at the last minute, so is not competing.

I maintained the cap of £3.40 used in the first round.
</details>

### Post Quarterfinals

```{r,echo = FALSE}
stakes <- read_csv("../../../track-cycling/data/bets/2020-08-05-Men-PostQuarterfinals.csv")
```

```{r, stakes-table, echo = FALSE}
```

<details>
<summary>All Other Odds</summary>
```{r, no-stakes-table, echo = FALSE}
```
</details>


<details>
<summary>Notes</summary>
These bets were placed following the quarterfinals, the day ahead of the semi-finals taking place.

At this point the model is very stable and is predicting almost identical win probabilities for the leading athletes.

In an effort to catch-up on the early loss on Glaetzer I'm going to lift my cap to £6.
</details>
:::

::: {.panel}
[Women]{.panel-name}


### Pre-Qualifying

```{r, echo = FALSE}
stakes <- read_csv("../../../track-cycling/data/bets/2020-08-05-Women-PreQualifying.csv")
```

```{r, stakes-table, echo = FALSE}
```

<details>
<summary>All Other Odds</summary>
```{r, no-stakes-table, echo = FALSE}
```
</details>

<details>
<summary>Notes</summary>
The idea of betting at this point is that hopefully the bookies odds are naive, as they won't have adjusted for qualifying times. We saw in the [previous post](https://www.infreq.com/posts/2021-07-28-tokyo-2020-ii/) qualifying data is highly predictive of match results.

Since qualifying times are not available I've fitted the model assuming all riders have the same qualifying time, and seeded them for matches in order of strength.
</details>

### Post Qualifying

```{r, echo = FALSE}
stakes <- read_csv("../../../track-cycling/data/bets/2020-08-06-Women-PostQualifying.csv")
```

```{r, stakes-table, echo = FALSE}
```

<details>
<summary>All Other Odds</summary>
```{r, no-stakes-table, echo = FALSE}
```
</details>


<details>
<summary>Notes</summary>
I've lifted the cap allowing me to bet up to £6.70. I've also decided to manually drop Lee Wai Sze's strength by 1 across all posterior samples as I believe the model is over estimating her strength based on historic performance. This is justified by her results in the Keirin, and the qualifying round for the sprint.
</details>

### Post Quarterfinals

:::

:::::


## Comments

## Acknowledgments {.appendix}


  
