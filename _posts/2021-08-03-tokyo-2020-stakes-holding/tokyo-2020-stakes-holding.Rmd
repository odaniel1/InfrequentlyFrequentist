---
title: "Tokyo 2020 Betting: My Stakes (Holding Post)"
description: |
  A holding post with the stakes I'm betting on the Individual Sprint. In the imminent future this post will be replaced by a full analysis of how I used draws from the Bradley-Terry model to derive the posterior distribution for the Gold medal winners of the track cycling Individual sprint. And how these were combined with the Kelly Criterion to derive optimised betting stakes under uncertainty.
date: 08-03-2021
output:
  distill::distill_article:
    toc: true
    toc_depth: 2
  self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, code_folding = TRUE)
options(kableExtra.html.bsTable = T)

library(tidyverse)
library(lubridate)
library(infreqthemes)
library(xaringanExtra)
library(knitr)
library(kableExtra)
library(fst)
library(formattable)

xaringanExtra::use_panelset()

remote_project_path <- '~/Documents/R Projects/track-cycling/'
remote_targets_path <- paste0(remote_project_path, '_targets/objects/')

read_remote_target <- function(name, path = remote_targets_path){
  
  file_path <- paste0(path,name)
  
  tar <- try(read_rds(file_path),silent=TRUE)
  
  if(class(tar) != 'try-error'){return(tar)}
  
  tar <- try(read_fst(file_path),silent=TRUE)
  
  if(class(tar) != 'try-error'){return(tar)}
  else{stop("Failed to read remote target")}
}

```

<details>
<summary>*This is the third post in a series: Click for links.*</summary>

[*Tokyo 2020 Betting I: Predictive Models for Pairwise Matches*](https://www.infreq.com/posts/2021-07-23-tokyo-2020-i/) 

[*Tokyo 2020 Betting II: Model Refinement and Feature Engineering*](https://www.infreq.com/posts/2021-07-28-tokyo-2020-ii/)

[*Tokyo 2020 Betting III: From Matches to Medals... and Bookies*](https://www.infreq.com/posts/2021-08-03-tokyo-2020-stakes-holding/) **(This Post)**
</details>

With the qualifying rounds of the Men's individual sprint starting tomorrow, its time to put some money behind my analysis.

The analytical workflow to go from model optimisation through to betting stakes are complete, but drafting a full blog post detailing how I've gone from predicting individual matches to entire tournaments, and then the defining betting stakes was beyond me in the time available.

<aside>All that detail in code form is available [here](https://github.com/odaniel1/track-cycling).</aside> 

In due course this blog post will morph to contain the details of the analysis - but for now this will be a holding space to report the odds I was being offered, and the and the stakes I put against these.

## Budget and Schedule

In total I'm allowing myself a budget of £20 - not exactly betting big, but also a non-negligible amount which will give me the flexibility to make a number of bets.

Going into the event I'm expecting to bet a total of six times (each time potentially spreading on multiple outcomes): three times for each of the Men/Women's events, and within the genders betting at three stages: before qualifying, after qualifying, and before the semi-finals!

My model will recommend a fraction of my total budget to bet at each stage; to avoid blowing my budget early I'll also cap my expenditure in earlier rounds at 1/6 of the total budget: i.e. the max the strategy will allow me to spend on the pre-qualifying Men/Women's bet is £3.40.

<aside>My stakes are derived from an non-linear optimisation problem that extends the basic [Kelly Criterion](https://en.wikipedia.org/wiki/Kelly_criterion) to handle multi-bet scenarios.</aside>

## Betting Log

::::: {.panelset}

::: {.panel}
[Men]{.panel-name}

### Pre-Qualifying

The idea of betting at this point is that hopefully the bookies odds are naive, as they won't have adjusted for qualifying times. We saw in the [previous post](https://www.infreq.com/posts/2021-07-28-tokyo-2020-ii/) qualifying data is highly predictive of match results.

Since qualifying times are not available I've fitted the model assuming all riders have the same qualifying time, and seeded them for matches in order of strength.

```{r, echo = FALSE}
stakes <- read_csv("../../../track-cycling/data/bets/2020-08-04-Men-PreQualifying.csv")
```

```{r stakes-table, echo = FALSE}
stakes %>%
  filter(capped_kelly_stakes > 0) %>%
  select(
    `Athlete` = rider, `Odds` = fractional_odds, `Stake` = capped_kelly_stakes,
    `Modelled Gold Prob.` = gold_prob, `Expected Return`= expected_return
  ) %>%
  kable("pipe", digits = 2)
```

<details>
<summary>All Other Odds</summary>
```{r no-stakes-table, echo = FALSE}
stakes %>%
  filter(capped_kelly_stakes == 0) %>%
 select(
    `Athlete` = rider, `Odds` = fractional_odds, `Stake` = capped_kelly_stakes,
    `Modelled Gold Prob.` = gold_prob, `Expected Return`= expected_return
  ) %>%
  kable("pipe", digits = 2)
```
</details>

### Post Qualifying
These bets were placed ahead of the 1/32 finals; at this point 24 athlete's remained in the competition.

Unfortunately at this point I'm already down £2.40 - Matthew Glaetzer was substituted out at the last minute, so is not competing.

I maintained the cap of £3.40 used in the first round.

```{r,echo = FALSE}
stakes <- read_csv("../../../track-cycling/data/bets/2020-08-04-Men-PostQualifying.csv")
```

```{r, stakes-table, echo = FALSE}
```

<details>
<summary>All Other Odds</summary>
```{r, no-stakes-table, echo = FALSE}
```
</details>

### Post Quarterfinals

These bets were placed following the quarterfinals, the day ahead of the semi-finals taking place.

At this point the model is very stable and is predicting almost identical win probabilities for the leading athletes.

In an effort to catch-up on the early loss on Glaetzer I'm going to lift my cap to £6.

```{r,echo = FALSE}
stakes <- read_csv("../../../track-cycling/data/bets/2020-08-05-Men-PostQuarterfinals.csv")
```

```{r, stakes-table, echo = FALSE}
```

<details>
<summary>All Other Odds</summary>
```{r, no-stakes-table, echo = FALSE}
```
</details>
:::

::: {.panel}
[Women]{.panel-name}


### Pre-Qualifying

The idea of betting at this point is that hopefully the bookies odds are naive, as they won't have adjusted for qualifying times. We saw in the [previous post](https://www.infreq.com/posts/2021-07-28-tokyo-2020-ii/) qualifying data is highly predictive of match results.

Since qualifying times are not available I've fitted the model assuming all riders have the same qualifying time, and seeded them for matches in order of strength.

```{r, echo = FALSE}
stakes <- read_csv("../../../track-cycling/data/bets/2020-08-05-Women-PreQualifying.csv")
```

```{r, stakes-table, echo = FALSE}
```

<details>
<summary>All Other Odds</summary>
```{r, no-stakes-table, echo = FALSE}
```
</details>

### Post Qualifying

I've lifted the cap allowing me to bet up to £6.70. I've also decided to manually drop Lee Wai Sze's strength by 1 across all posterior samples as I believe the model is over estimating her strength based on historic performance. This is justified by her results in the Keirin, and the qualifying round for the sprint.

```{r, echo = FALSE}
stakes <- read_csv("../../../track-cycling/data/bets/2020-08-06-Women-PostQualifying.csv")
```

```{r, stakes-table, echo = FALSE}
```

<details>
<summary>All Other Odds</summary>
```{r, no-stakes-table, echo = FALSE}
```
</details>


### Post Quarterfinals

:::

:::::


## Comments

## Acknowledgments {.appendix}


  
